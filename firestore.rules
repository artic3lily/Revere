rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function userDocExists(uid) {
      return exists(/databases/$(database)/documents/users/$(uid));
    }

    function isAdmin() {
      return signedIn()
        && userDocExists(request.auth.uid)
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    function isBlocked(uid) {
      return userDocExists(uid)
        && (
          get(/databases/$(database)/documents/users/$(uid)).data.get('accountStatus', 'active') == "banned"
          ||
          (
            get(/databases/$(database)/documents/users/$(uid)).data.get('accountStatus', 'active') == "suspended"
            &&
            request.time < get(/databases/$(database)/documents/users/$(uid)).data.get('suspendedUntil', request.time)
          )
        );
    }

    function okUser() {
      return signedIn() && !isBlocked(request.auth.uid);
    }

    /* ---------- USERS ---------- */
    match /users/{uid} {

      // allow user to create their doc after auth signup
      allow create: if isOwner(uid);

      // admin can read anyone, normal users cannot read blocked userprofile
      allow read: if okUser();

      // admin OR ownr but not actualy blocked OR rating an account
      allow update: if isAdmin()
        || (isOwner(uid) && !isBlocked(request.auth.uid))
        || (okUser() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['ratingAvg', 'ratingCount']));

      allow delete: if isAdmin();

      match /cart/{itemId} {
        allow read, write: if okUser() && isOwner(uid);
      }

      match /wishlist/{itemId} {
        allow read, write: if okUser() && isOwner(uid);
      }

      match /chatMessages/{msgId} {
        allow read, write: if okUser() && isOwner(uid);
      }

      match /chats/{chatId} {
        allow read, write: if okUser() && isOwner(uid);
        match /messages/{msgId} {
          allow read, write: if okUser() && isOwner(uid);
        }
      }
    }

    // POSTS //
    match /posts/{postId} {

      allow read: if okUser();

      allow create: if okUser();

      allow update, delete: if isAdmin()
        || (okUser() && request.auth.uid == resource.data.ownerId);
    }

    // follow system
    match /followers/{userId}/users/{followerId} {

      //if target user is blocked, followers list is invisible
      allow read: if okUser();

      // cannot follow a blocked user
      allow write: if okUser()
        && request.auth.uid == followerId
        && !isBlocked(userId);
    }

    match /following/{userId}/users/{followingId} {

      // if target user is blocked, following list is invisible
      allow read: if okUser();

      // cannot follow a blocked user
      allow write: if okUser()
        && request.auth.uid == userId
        && !isBlocked(followingId);
    }

    // ratings system
    match /ratings/{userId}/users/{raterId} {
      allow read: if okUser();
      allow write: if okUser() && request.auth.uid == raterId && !isBlocked(userId);
    }

    // thread box
    match /threads/{uid}/chats/{threadId} {
      allow read, write: if okUser() && isOwner(uid);
    }

    //message box
    match /threads/{threadId} {

      allow read: if okUser()
        && (resource == null || request.auth.uid in resource.data.members);

      allow create: if okUser()
        && request.auth.uid in request.resource.data.members;

      allow update: if okUser()
        && request.auth.uid in resource.data.members;

      match /messages/{messageId} {
        allow read, create: if okUser()
          && request.auth.uid in get(/databases/$(database)/documents/threads/$(threadId)).data.members;

        allow update, delete: if false;
      }
    }

    // REPORTS //
    match /reports/{reportId} {
      allow create: if okUser() && request.auth.uid == request.resource.data.reporterId;
      allow read, update: if isAdmin();
      allow delete: if isAdmin();
    }

    // default denyy
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
